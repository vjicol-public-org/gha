name: Label Deploy Requests

on:
  issues:
    types: [opened, edited]
    
permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write
  


jobs:
  label:
    runs-on: ubuntu-latest
    if: github.event.issue.labels.*.name != 'deploy-request'
    steps:
      - name: Check issue label
        id: label-check
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const labels = context.payload.issue.labels.map(label => label.name);
            const hasLabel = labels.includes('deploy-request');

            if (!hasLabel) {
              const message = `‚ùå This issue must be labeled with \`deploy-request\` to trigger deployment validation.`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: message,
              });
              core.setFailed(message);
            }
            else {
              console.log(`‚úÖ Issue #${issue_number} is labeled with 'deploy-request'.`);
            }
  validate-user:
    needs: label
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Check user team and post error if unauthorized
        uses: actions/github-script@v7
        with:
          script: |
            const username = 'dummy-user';
            const teamSlug = 'prod';
            console.log(`‚úÖ @${username} is a member of "${teamSlug}".`);

  terraform-plan:
    needs: validate-user
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::295616346134:role/github-terraform-deployer
          aws-region: us-east-1
          role-session-name: github-actions

      - name: Terraform Init & Plan
        id: init
        run: |
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform destroy -out=tfplan -no-color > plan.txt
          echo "TERRAFORM_PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat plan.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Terraform Plan File
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan
      
    
      - name: Comment Plan on Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## üì¶ Terraform Plan for `${{ github.event.repository.name }}`
            <details>
            <summary>Click to expand plan output</summary>
      
            ```
            ${{ steps.plan.outputs.TERRAFORM_PLAN_OUTPUT }}
            ```
      
            </details>

  # Job that requests approval
  request-approval:
    needs: terraform-plan
    runs-on: ubuntu-latest
    environment:
      name: prod-deploy-approval
    outputs:
      env-name: ${{ steps.setenv.outputs.env }}
    steps:
      - name: Set environment name for output
        id: setenv
        run: echo "env=prod-deploy-approval" >> $GITHUB_OUTPUT

      - name: Comment approval granted
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚úÖ Deployment to **${{ steps.setenv.outputs.env }}** was approved.

      - name: Add label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['approved', 'prod-deploy-approved']
            });

# Watchdog job to handle rejection
  handle-rejection:
    needs: [request-approval]
    if: failure() || cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Comment rejection on GitHub issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚ùå Deployment was **rejected or cancelled** via environment approval.

      - name: Add 'rejected' label to GitHub issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['rejected', 'prod-deploy-rejected']
            });
# Job to deploy Terraform plan after approval

  terraform-deploy:
    needs: request-approval
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::295616346134:role/github-terraform-deployer
          aws-region: us-east-1
          role-session-name: github-actions

      - name: Download Terraform Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .

      - name: Terraform Init
        run: terraform init
        
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
