name: Label Deploy Requests

on:
  issues:
    types: [opened, edited]
    
permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write
  


jobs:
  label:
    runs-on: ubuntu-latest
    if: github.event.issue.labels.*.name != 'deploy-request'
    steps:
      - name: Check issue label
        id: label-check
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const labels = context.payload.issue.labels.map(label => label.name);
            const hasLabel = labels.includes('deploy-request');

            if (!hasLabel) {
              const message = `âŒ This issue must be labeled with \`deploy-request\` to trigger deployment validation.`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: message,
              });
              core.setFailed(message);
            }
            else {
              console.log(`âœ… Issue #${issue_number} is labeled with 'deploy-request'.`);
            }
  validate-user:
    needs: label
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Check user team and post error if unauthorized
        uses: actions/github-script@v7
        with:
          script: |
            const username = 'dummy-user';
            const teamSlug = 'prod';
            console.log(`âœ… @${username} is a member of "${teamSlug}".`);

  terraform-plan:
    needs: validate-user
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::295616346134:role/github-terraform-deployer
          aws-region: us-east-1
          role-session-name: github-actions

      - name: Terraform Init & Plan
        id: init
        run: |
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan -no-color > plan.txt
          echo "TERRAFORM_PLAN_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat plan.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment Plan on Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ðŸ“¦ Terraform Plan for `${{ github.event.repository.name }}`
            <details>
            <summary>Click to expand plan output</summary>
      
            ```
            ${{ steps.plan.outputs.PLAN_OUTPUT }}
            ```
      
            </details>
        